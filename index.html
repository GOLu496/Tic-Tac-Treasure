<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<style>
    body {
        margin: 0;
        padding: 0;
        display: flex;
        height: 100vh;
        background: transparent; /* background transparent */
        color: white;
        font-family: Arial, sans-serif;
    }
    .side {
        width: 20%;
        background: transparent;
        display: none;
    }
    @media (min-width: 1024px) {
        .side { display: block; }
    }
    .center {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 10px;
        background: transparent;
    }
    .big-square {
        background: transparent; /* transparent background */
        border-radius: 15px;
        width: 99%;
        aspect-ratio: 1 / 1;
        display: flex;
        justify-content: center;
        align-items: center;
        position: relative;
        overflow: hidden;
    }
    .board {
        position: absolute;
        width: 90%;
        aspect-ratio: 1 / 1;
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 0;
        visibility: hidden; /* initially hidden, show on start */
        background: transparent;
        border: 2px solid black; /* black border around board */
    }
    .cell {
        background: transparent; /* transparent background */
        border: 1px solid black; /* black grid lines */
        border-radius: 0;
        aspect-ratio: 1 / 1;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        user-select: none;
        overflow: hidden;
        box-sizing: border-box;
    }
    .cell img {
        width: 100%;
        height: 100%;
        object-fit: cover; 
        display: block;
        pointer-events: none;
    }

    .menu { text-align: center; background: transparent; }
    .menu .mode {
        display: block;
        margin: 15px auto;
        font-size: 2em;
        border-radius: 10px;
        cursor: pointer;
        border: none;
        transition: 0.3s ease;
        width: 50vw;
        height: 20vh;
        background: transparent;
    }
    .menu .mode-bot img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: block;
    }

    .winner-screen { 
        text-align: center; 
        display: none; 
        background: transparent;
        color: black;
    }
    .winner-screen h2 { 
        font-size: 28px; 
        margin-bottom: 15px; 
    }
    .winner-screen button#restartBtn {
        width: 150px;
        height: 60px;
        padding: 0;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        background: none;
        display: none; /* initially hidden */
    }
    .winner-screen button#restartBtn img {
        width: 100%;
        height: 100%;
        object-fit: contain;
        display: block;
        pointer-events: none;
    }
    #backHome {
        margin-top: 10px;
        background: #f44336;
        color: white;
        padding: 8px 15px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        display: none;
    }
    .win-line {
        position: absolute;
        height: 4px;
        background: red;
        transform-origin: 0 50%;
        z-index: 10;
    }
</style>
</head>
<body>

<div class="big-square">
    <div class="board" id="board">
        <div class="cell" data-index="0"></div>
        <div class="cell" data-index="1"></div>
        <div class="cell" data-index="2"></div>
        <div class="cell" data-index="3"></div>
        <div class="cell" data-index="4"></div>
        <div class="cell" data-index="5"></div>
        <div class="cell" data-index="6"></div>
        <div class="cell" data-index="7"></div>
        <div class="cell" data-index="8"></div>
    </div>

    <div class="menu" id="menu">
        <button class="mode mode-bot" onclick="setMode('bot')">
            <img src="3.png" alt="start" />
        </button>
    </div>

    <div class="winner-screen" id="winnerScreen">
        <h2 id="winnerText"></h2>
        <button id="restartBtn" onclick="window.location.href='https://www.google.com'">
            <img src="4.png" alt="restart" />
        </button>
    </div>
</div>

<script>
let gameMode = null;
let turn = "X";
let gameOver = false;

let xOrder = [];
let oOrder = [];

let tokenImages = {
  X: localStorage.getItem("tokenX") || null,
  O: localStorage.getItem("tokenO") || null
};

const defaultImages = {
  X: "1.png",
  O: "2.png"
};

const winPatterns = [
  [0,1,2],[3,4,5],[6,7,8],
  [0,3,6],[1,4,7],[2,5,8],
  [0,4,8],[2,4,6]
];

function setMode(mode) {
  gameMode = mode;
  document.getElementById("menu").style.display = "none";
  document.getElementById("board").style.visibility = "visible";

  // Hide winner screen & restart button initially on start
  document.getElementById("winnerScreen").style.display = "none";
  document.getElementById("restartBtn").style.display = "none";

  document.getElementById("backHome").style.display = "inline-block";
}

function showWinner(symbol) {
  gameOver = true;
  document.getElementById("board").style.visibility = "hidden";
  document.getElementById("winnerText").textContent = `Winner: ${symbol}`;
  document.getElementById("winnerScreen").style.display = "block";
  document.getElementById("backHome").style.display = "none";

  // Show restart button only on game end
  document.getElementById("restartBtn").style.display = "inline-block";

  // Notify Kodular app about winner
  if (window.Kodular && typeof window.Kodular.setWebViewString === "function") {
    window.Kodular.setWebViewString("winner:" + symbol);
  }
}

function restartGame() {
  clearBoard();
  document.getElementById("winnerScreen").style.display = "none";
  document.getElementById("menu").style.display = "block";

  // Hide restart button when restarting
  document.getElementById("restartBtn").style.display = "none";
}

function clearBoard() {
  document.querySelectorAll(".cell").forEach(c => {
    c.innerHTML = "";
    c.removeAttribute("data-symbol");
  });
  xOrder = [];
  oOrder = [];
  turn = "X";
  gameOver = false;
  document.querySelectorAll(".win-line").forEach(line => line.remove());
}

function drawWinningLine(pattern) {
  const board = document.getElementById("board");
  const cells = document.querySelectorAll(".cell");
  const rectA = cells[pattern[0]].getBoundingClientRect();
  const rectC = cells[pattern[2]].getBoundingClientRect();
  const boardRect = board.getBoundingClientRect();
  const x1 = rectA.left + rectA.width / 2 - boardRect.left;
  const y1 = rectA.top + rectA.height / 2 - boardRect.top;
  const x2 = rectC.left + rectC.width / 2 - boardRect.left;
  const y2 = rectC.top + rectC.height / 2 - boardRect.top;
  const line = document.createElement("div");
  line.classList.add("win-line");
  line.style.width = Math.hypot(x2 - x1, y2 - y1) + "px";
  line.style.transform = `translate(${x1}px,${y1}px) rotate(${Math.atan2(y2 - y1, x2 - x1)}rad)`;
  board.appendChild(line);
}

function checkWinnerFromBoardArr(arr) {
  for (const p of winPatterns) {
    const [a, b, c] = p;
    if (arr[a] && arr[a] === arr[b] && arr[a] === arr[c]) return arr[a];
  }
  return null;
}

function getBoardArr() {
  return [...document.querySelectorAll(".cell")].map(c => c.dataset.symbol || null);
}

function checkWinnerUI() {
  const winner = checkWinnerFromBoardArr(getBoardArr());
  if (winner) {
    const pattern = winPatterns.find(p => p.every(i => getBoardArr()[i] === winner));
    if (pattern) drawWinningLine(pattern);
    setTimeout(() => showWinner(winner), 600);
    return true;
  }
  return false;
}

function placeSymbol(cell, symbol) {
  const idx = +cell.getAttribute("data-index");
  if (cell.dataset.symbol) return false;

  const img = document.createElement("img");
  img.src = tokenImages[symbol] || defaultImages[symbol];
  cell.innerHTML = "";
  cell.appendChild(img);
  cell.dataset.symbol = symbol;

  if (symbol === "X") {
    xOrder.push(idx);
    if (xOrder.length > 3) {
      const rem = xOrder.shift();
      const rc = document.querySelector(`.cell[data-index="${rem}"]`);
      if (rc) {
        rc.innerHTML = "";
        rc.removeAttribute("data-symbol");
      }
    }
  } else {
    oOrder.push(idx);
    if (oOrder.length > 3) {
      const rem = oOrder.shift();
      const rc = document.querySelector(`.cell[data-index="${rem}"]`);
      if (rc) {
        rc.innerHTML = "";
        rc.removeAttribute("data-symbol");
      }
    }
  }
  return true;
}

document.querySelectorAll(".cell").forEach(cell => {
  cell.addEventListener("click", () => {
    if (gameOver) return;
    if (!placeSymbol(cell, turn)) return;

    if (checkWinnerUI()) return;

    if (gameMode === "bot" && turn === "X") {
      turn = "O";
      setTimeout(botMove, 250);
    } else {
      turn = (turn === "X") ? "O" : "X";
    }
  });
});

const MAX_DEPTH = 10;

function botMove() {
  if (gameOver) return;

  const state = readState();
  let bestScore = -Infinity;
  let bestIdx = null;

  const legal = legalPlacements(state, "O");
  for (const idx of legal) {
    const next = applyPlacement(state, idx, "O");
    const score = minimax(next, 1, -Infinity, Infinity, false);
    if (score > bestScore) {
      bestScore = score;
      bestIdx = idx;
    }
  }

  if (bestIdx !== null) {
    const cell = document.querySelector(`.cell[data-index="${bestIdx}"]`);
    placeSymbol(cell, "O");
    if (checkWinnerUI()) return;
    turn = "X";
  }
}

function readState() {
  const board = getBoardArr();
  return {
    board,
    xOrder: [...xOrder],
    oOrder: [...oOrder]
  };
}

function legalPlacements(state, who) {
  const res = [];
  for (let i = 0; i < 9; i++) if (state.board[i] == null) res.push(i);
  return res;
}

function applyPlacement(state, idx, who) {
  const board = state.board.slice();
  const xQ = state.xOrder.slice();
  const oQ = state.oOrder.slice();

  if (board[idx] != null) return state;
  board[idx] = who;
  if (who === "X") {
    xQ.push(idx);
    if (xQ.length > 3) {
      const rem = xQ.shift();
      board[rem] = null;
    }
  } else {
    oQ.push(idx);
    if (oQ.length > 3) {
      const rem = oQ.shift();
      board[rem] = null;
    }
  }
  return { board, xOrder: xQ, oOrder: oQ };
}

function terminalScore(board, depth) {
  const w = checkWinnerFromBoardArr(board);
  if (w === "O") return 100 - depth;
  if (w === "X") return depth - 100;
  return null;
}

function heuristic(board) {
  let score = 0;
  for (const p of winPatterns) {
    const [a, b, c] = p;
    const line = [board[a], board[b], board[c]];
    const o = line.filter(v => v === "O").length;
    const x = line.filter(v => v === "X").length;
    const e = 3 - o - x;
    if (o > 0 && x > 0) continue;
    if (o === 2 && e === 1) score += 6;
    else if (o === 1 && e === 2) score += 2;
    else if (x === 2 && e === 1) score -= 6;
    else if (x === 1 && e === 2) score -= 2;
  }
  if (board[4] === "O") score += 1;
  else if (board[4] === "X") score -= 1;
  [0, 2, 6, 8].forEach(i => {
    if (board[i] === "O") score += 0.5;
    else if (board[i] === "X") score -= 0.5;
  });
  return score;
}

function minimax(state, depth, alpha, beta, maximizing) {
  const term = terminalScore(state.board, depth);
  if (term !== null) return term;
  if (depth >= MAX_DEPTH) return heuristic(state.board);

  if (maximizing) {
    let best = -Infinity;
    const moves = legalPlacements(state, "O");
    for (const idx of moves) {
      const next = applyPlacement(state, idx, "O");
      const val = minimax(next, depth + 1, alpha, beta, false);
      best = Math.max(best, val);
      alpha = Math.max(alpha, val);
      if (beta <= alpha) break;
    }
    return best;
  } else {
    let best = Infinity;
    const moves = legalPlacements(state, "X");
    for (const idx of moves) {
      const next = applyPlacement(state, idx, "X");
      const val = minimax(next, depth + 1, alpha, beta, true);
      best = Math.min(best, val);
      beta = Math.min(beta, val);
      if (beta <= alpha) break;
    }
    return best;
  }
}
</script>

</body>
</html>
